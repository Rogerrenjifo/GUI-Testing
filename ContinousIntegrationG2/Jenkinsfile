pipeline {
  agent any
  environment {
    PYTHONPATH = "${WORKSPACE}\\"
    PASSWORD=credentials('PASSWORD')
    USER=credentials('USER')
    BROWSER="chrome"
    DEVICE="pc"
    DRIVER_PATH=".\\"
    IMPLICIT_TIMEOUT="60"
    CI_EXECUTION="False"
    virtualenvDir = "${WORKSPACE}\\venv"
  }
  stages{
    stage('Install Dependencies') {
      steps {
        dir("${WORKSPACE}"){
          script {
            bat "python -m venv ${virtualenvDir}"
            bat ".\\venv\\Scripts\\activate"
            bat "${virtualenvDir}\\Scripts\\pip install -r ${WORKSPACE}\\requeriments.txt"
          }
        }
      }
    }
    stage('Run Functional'){
      steps{
        dir("${WORKSPACE}"){
          bat '.\\venv\\Scripts\\robot  --outputdir .\\Blueprint\\Reports\\HappyPath -i PROJECT -e NEGATIVE .\\Blueprint\\TestCases'
        }
      }
      post {
        always {
          archiveArtifacts artifacts: 'Blueprint/Reports/HappyPath/log.html', fingerprint: true
          archiveArtifacts artifacts: 'Blueprint/Reports/HappyPath/report.html', fingerprint: true
          archiveArtifacts artifacts: 'Blueprint/Reports/HappyPath/output.xml', fingerprint: true
        }
      }
    }
    stage('Run Regretion Test Cases'){
      steps{
        dir("${WORKSPACE}"){
          bat '.\\venv\\Scripts\\robot  --outputdir .\\Blueprint\\Reports\\Regretion -i PROJECT .\\Blueprint\\TestCases'
        }
      }
      post {
        always {
          archiveArtifacts artifacts: 'Blueprint/Reports/Regretion/log.html', fingerprint: true
          archiveArtifacts artifacts: 'Blueprint/Reports/Regretion/report.html', fingerprint: true
          archiveArtifacts artifacts: 'Blueprint/Reports/Regretion/output.xml', fingerprint: true
        }
      }
    }
    stage('Run Test Mobile Device'){
      environment {
        DEVICE='galaxy s20 ultra'
        IMPLICIT_TIMEOUT="30"
      }
      steps{
        dir("${WORKSPACE}"){
          bat '.\\venv\\Scripts\\robot  --outputdir .\\Blueprint\\Reports\\MobileDevice -i PROJECT .\\Blueprint\\TestCases'
        }
      }
      post {
        always {
          archiveArtifacts artifacts: 'Blueprint/Reports/MobileDevice/log.html', fingerprint: true
          archiveArtifacts artifacts: 'Blueprint/Reports/MobileDevice/report.html', fingerprint: true
          archiveArtifacts artifacts: 'Blueprint/Reports/MobileDevice/output.xml', fingerprint: true
        }
      }
    }
  }
  // post {
  //   always {
  //     script {
  //       bat "rmdir /s /q ${virtualenvDir}"
  //     }
  //   }
  // }
}

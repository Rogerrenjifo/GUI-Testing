pipeline {
  agent any
  environment {
    PYTHONPATH = "${WORKSPACE}"
    REPO_NAME = "${GIT_URL.split('/')[-2]}/${GIT_URL.split('/')[-1].replace('.git', '')}"
    USER=credentials('user')
    PASSWORD=credentials('password')
    BROWSER="remote_chrome"
    IMPLICIT_TIMEOUT="60"
  }
  stages {          
    stage('Build Browser Environments') {    
      steps {
        script {
          catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
            bat 'docker run -d -p 4444:4444 --name chrome -p 7900:7900 --shm-size="2g" selenium/standalone-chrome:latest'
          }    
        }
      }
    }
    stage('RegretionTestPC'){
      environment {
        DEVICE="pc"
      }
      steps {
        script{
          catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
            bat ".\\venv\\Scripts\\robot  --outputdir .\\Blueprint\\Reports -i ROGER .\\Blueprint\\TestCases"
          }
        }
      }
      post {
        always {
          script {
            stepName = "RegretionTestPC"
            folderPath = "${env.WORKSPACE}\\Blueprint\\Reports\\${stepName}"
            if (!fileExists(folderPath)) {
              bat "mkdir ${folderPath}"
            }
            bat 'move .\\Blueprint\\Reports\\log.html ${folderPath}\\log.html'
            bat 'move .\\Blueprint\\Reports\\output.xml ${folderPath}\\output.xml'
            bat 'move .\\Blueprint\\Reports\\report.html ${folderPath}\\report.html'
          }
        }
      }
    }
  } 
  post{
    always{
      archiveArtifacts artifacts: "Blueprint/Reports/**/log.html", fingerprint: true, allowEmptyArchive: true
      bat 'docker container stop chrome'
      bat 'docker container rm chrome'
    }
  }
}
